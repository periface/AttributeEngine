var Engine=function(n){function i(n,t,i){for(var r=0;r<n.length;r++)if(n[r][t]===i)return n[r];return undefined}function c(n,t){for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);return n}function e(n){return n.substring(n.indexOf(".")+1)}function o(u){var o=u.split("."),f,e;for(n.enableDebug&&console.info("Resolving service by convention"),f=0;f<o.length;f++)if(e=i(t.propertyServices,r,o[f]),e!=undefined)return f>0?(console.warn("Warning: The service "+e.propertyServiceName+" was resolved in position "+f),undefined):e;return undefined}var u,f,s;n||(console.warn("Options r null loading defaults..."),n={useOverlay:!0,autoStart:!1,overlayObj:undefined,enableDebug:!1,onAllRequestsFinished:undefined,resolveByConvention:!1});var t=this,r="propertyServiceName",h="iterationServiceName";return this.propertyServices=[],this.iterationServices=[],u=function(n,t,i){this.mainContext=i;this.parentContext=t;this.iterationTemplate=n},this.defineIterationService=function(n,i){t.iterationServices.push({iterationServiceName:n,iterationServiceEndPoint:i})},this.definePropertyService=function(n,i){t.propertyServices.push({propertyServiceName:n,propertyServiceEndPoint:i})},f=function(n,t,i,r,u,f,e,o,s,h){this.propertyRequest=n;this.propertyServiceName=t;this.printInProperty=i;this.replicate=r;this.callbackFunc=u;this.runAsync=o;this.useFuncOnly=f;this.requestProperties=e;this.element=s;this.iterationObjName=h},this.lookForChilds=function(n){setTimeout(function(){console.log("Now looking for childs inside context -->");var i=$(n[0]).find("[data-iterate]");i.length>0?(console.log("The context has "+i.length+" childs"),$.each(i,function(n,i){var f=$(i),e=$(i).parentsUntil("[data-parent]").parent().closest("[data-parent]"),o=$(i).children().closest("[data-template]"),r=new u(o,e,f);console.log(r);t.processContext(r,t.deferred)})):console.log("No childs")})},this.processContext=function(n,r){setTimeout(function(){var u;if(n){console.log("Processing context ->");console.log(n);var e=n.mainContext.data("iterate"),o=n.mainContext.data("source"),s=n.mainContext.data("beforesend"),f=i(t.iterationServices,h,o);f==undefined?console.error("Iteration service undefined for "+o):(u=n.parentContext.data("iterationfinished"),u===!0?(console.log("Parent has finished for "),console.log(n),t.buildAjaxIObj(n,f.iterationServiceEndPoint,r,e,s)):(console.log(u),u==undefined&&(console.log(n.parentContext.length<=0),n.parentContext.length<=0&&t.buildAjaxIObj(n,f.iterationServiceEndPoint,r,e,s))))}},0)},this.deferred=[],this.listener=function(){function s(){$("[data-property]").each(function(u,s){var y=$(s),h=$(s).data("property"),a=$(s).data("servicename"),p=$(s).data("printproperty"),w=$(s).data("replicate"),b=$(s).data("callback"),k=$(s).data("ignoreall"),d=$(s).data("params"),v=$(s).data("async"),l,c;v==undefined&&(v=!0);l=new f(h,a,p,w,b,k,d,v,y);n.resolveByConvention?(c=o(h),c==undefined?(n.enableDebug&&console.warn("Resolve by convention failed for property "+h+" trying to resolve the service by default"),c=i(t.propertyServices,r,a)):(n.enableDebug&&console.warn("Resolve by convention succeded for property "+h),l.propertyRequest=e(l.propertyRequest))):c=i(t.propertyServices,r,a);c==undefined?(console.warn("Service undefined for property "+h),n.enableDebug&&console.info("Trying to get the service by convention for property "+h),c=o(h),c==undefined?(console.warn("Second try : Service undefined for property "+h),console.info("Seems like you have the convention resolver inactive and you dont have a data-servicename defined for this property ("+h+"), skipping.....")):(console.info("The convention resolver fixed the problem, but please check the code or enable the convention resolver in the options object"),l.propertyRequest=e(l.propertyRequest),t.buildAjaxObj(c.propertyServiceEndPoint,l,t.deferred))):t.buildAjaxObj(c.propertyServiceEndPoint,l,t.deferred)})}function h(){$("[data-iterate]").each(function(n,i){var e=$(i),r,f,o;console.log("Main context");console.log(e);console.log("Template context");r=$(i).children().closest("[data-template]");console.log(r);console.log("Parent iteration context");f=$(i).parentsUntil("[data-parent]").parent().closest("[data-parent]");console.log(f);o=new u(r,f,e);t.processContext(o,t.deferred)})}s();h();$.when.apply($,t.deferred).done(t.allDoneFunction)},n.autoStart&&t.listener(),s=function(n){return Object.assign(n)},this.buildAjaxIObj=function(n,i,r,u,f){var e={};(n!==""||n!=undefined||n!==null)&&i!==""&&r.push($.ajax({url:i,data:e,beforeSend:function(i,r){f!=undefined&&t.callFunction(f,e,n,function(n){n&&(r.url=r.url+"/"+n.Id)})},statusCode:{500:function(){console.log("500 error on context");console.log(n);console.log("Iterate value"+u)}},error:function(){console.warn("Endpoint ("+i+") failed");return}}).done(function(i){var r=[];$.each(i,function(n,t){r.push(new s(t))});t.processTemplate(n.iterationTemplate,r,u);n.mainContext.attr("data-iterationfinished",!0);t.lookForChilds(n.mainContext,!0)}))},this.processTemplate=function(n,i,r){var e=n.html(),u;n.html("");n.append("<!--IterationContext for "+r+"-->");$.each(i,function(t){var i="<div data-identifier="+t+">";i+=e;i+="<\/div>";n.append(i)});u=n.find("[data-identifier]");u.each(function(n,u){var e=$(u).data("identifier"),o=$(u).find("[data-iproperty]");o.each(function(n,u){var o=$(u).data("iproperty"),s=$(u).data("printproperty"),h=$(u).data("replicate"),c=$(u).data("callback"),l=$(u).data("ignoreall"),a=t.resolvePropertyValue(o,i[e]),v=$(u),y=new f(o,"",s,h,c,l,undefined,!0,v,r);t.bindDataOfIteration(y,a)})});n.append("<!--End of IterationContext for"+r+"-->")},this.bindDataOfIteration=function(n,i){n.callbackFunc?n.useFuncOnly?t.callFunction(n.callbackFunc,i,n.element):(t.bindData(n,i),t.callFunction(n.callbackFunc,i,n.element)):t.bindData(n,i)},this.resolvePropertyValue=function(t,i){var r;n.enableDebug&&console.log("Trying to resolve "+t+" from object -->");for(r in i)if(Object.prototype.hasOwnProperty.call(i,r)&&t===r)return i[r]},this.buildAjaxObj=function(n,i,r){if(n!==""&&i.propertyRequest!==""){var u=t.resolveDataRequest(i.propertyRequest,i.requestProperties);r.push($.ajax({url:n,data:u,async:i.runAsync}).done(function(n){i.callbackFunc?i.useFuncOnly?t.callFunction(i.callbackFunc,n,i.element):(t.bindData(i,u),t.callFunction(i.callbackFunc,n,i.element)):t.bindData(i,n)}))}},this.callFunction=function(n,t,i,r){try{window[n](t,i,function(n){r(n)})}catch(u){console.warn("Callback function has failed to execute or has some internal errors, please check it out --->");console.log("----------------------------------");console.log(u);console.log("----------------------------------");console.info("Dont try to eval the function in the lib source dude... pls -->");console.info("Lets continue....");return}},this.allDoneFunction=function(){n.onAllRequestsFinished?(n.onAllRequestsFinished(),n.useOverlay&&t.hideOverlay()):(n.useOverlay&&t.hideOverlay(),console.log("All requests done"))},this.hideOverlay=function(){n.overlayObj?document.getElementById(n.overlayObj).style.width="0%":console.warn("No overlay defined")},this.bindData=function(n,i){n.printInProperty?(n.element.attr(n.printInProperty,i),n.replicate?t.appendDataInDomElement(n,i):t.appendOnlyId(n)):t.appendDataInDomElement(n,i)},this.appendDataInDomElement=function(n,t){n.element.text(t);n.element.attr("id",n.propertyRequest);n.element.attr("data-property-finished",!0)},this.appendOnlyId=function(n){n.element.attr("id",n.propertyRequest);n.element.attr("data-property-finished",!0)},this.getValueFromDomElement=function(n){var t=document.getElementById(n).value;return t?t:undefined},this.getValue=function(n,u,f,e){var o=i(t.propertyServices,r,n);o==undefined?console.error("Service undefined"):t.getValueFromService(o,u,f,function(n){e(n)})},this.getValueFromService=function(n,i,r,u){var f=t.resolveDataRequest(i,r);$.ajax({url:n.propertyServiceEndPoint,data:f,success:function(n){u(n)}})},this.resolveDataRequest=function(t,i){var u={key:t},r;return i!=undefined?(r=c(u,i),n.enableDebug&&(console.info("The request object has been extended --->"),console.log(r)),r):u},{propertyServices:this.propertyServices,defineNewPropertyService:this.definePropertyService,defineIterationSericePoint:this.defineIterationService,getValueFromDom:this.getValueFromDomElement,startListener:this.listener,getValue:this.getValue}};